---
import type { Metadata } from '../types';
import SearchBar from '../components/SearchBar';
import TagsDropdown from '../components/TagsDropdown';
import MobileMenu from '../components/MobileMenu';
import { getCollection } from 'astro:content';
import { AstroFont } from 'astro-font';
import '@/styles/global.css';

interface Props {
  title?: string;
  description?: string;
}

const metadata: Metadata = {
  title: 'logos.travel',
  url: 'https://logos.travel/',
  language: 'en',
  description: 'Browse and download logos from airlines, hotels, tourism boards, and more. logos.travel is a curated directory of travel-related brand logos, free to access and easy to use.',
  author: {
    name: 'Gerrit Halfmann',
    email: 'gerrit@gerrithalfmann.com',
    url: 'https://halfmage.com',
  },
};

const { title, description } = Astro.props;
const pageTitle = title ? `${title} ‚Äî logos.travel` : 'logos.travel ‚Äî Find and Download Travel Brand Logos Instantly';
const pageDescription = description || metadata.description;

// Prepare search data
const logos = await getCollection('logos');
const slugifyTag = (tag: string): string => {
  return tag
    .replace(/[^\w\s-]/g, '') // Remove emojis and special chars
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/--+/g, '-');
};

const logoEntries = logos.map((logo) => {
  const idParts = logo.id.split('/');
  const simpleId = idParts.length > 1 ? idParts[0] : logo.id;
  return {
    type: 'logo' as const,
    title: logo.data.name,
    id: simpleId,
    url: `/logos/${simpleId}/`,
  };
});

const allTags = new Set<string>();
logos.forEach(logo => {
  if (logo.data.tags) {
    logo.data.tags.forEach(tag => allTags.add(tag));
  }
});

const tagEntries = Array.from(allTags).map((tag) => ({
  type: 'tag' as const,
  title: tag,
  url: `/tags/${slugifyTag(tag)}/`,
}));

// Calculate tag counts for dropdown
const tagMap = new Map<string, number>();
logos.forEach(logo => {
  if (logo.data.tags) {
    logo.data.tags.forEach(tag => {
      tagMap.set(tag, (tagMap.get(tag) || 0) + 1);
    });
  }
});

// Sort tags by count (descending), then alphabetically
const sortedTagsWithCounts = Array.from(tagMap.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1]; // By count
    return a[0].localeCompare(b[0]); // Then alphabetically
  })
  .map(([tag, count]) => ({
    tag,
    count,
    url: `/tags/${slugifyTag(tag)}/`,
  }));

const searchData = {
  logos: logoEntries,
  tags: tagEntries,
};
---

<!doctype html>
<html lang={metadata.language}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.svg" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={metadata.url} />
    <meta property="og:type" content="website" />
    <meta property="og:image" content={`${metadata.url}social.jpg`} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={`${metadata.url}social.jpg`} />
    <AstroFont
      config={[
        {
          name: "Manrope",
          src: [
            {
              style: "normal",
              weight: "400",
              path: "https://fonts.gstatic.com/s/manrope/v15/xn7_YHE41ni1AdIRggexSd-fed4vYI.woff2",
            },
            {
              style: "normal",
              weight: "500",
              path: "https://fonts.gstatic.com/s/manrope/v15/xn7_YHE41ni1AdIRggexSd-fed4vYI.woff2",
            },
            {
              style: "normal",
              weight: "600",
              path: "https://fonts.gstatic.com/s/manrope/v15/xn7_YHE41ni1AdIRggexSd-fed4vYI.woff2",
            },
            {
              style: "normal",
              weight: "700",
              path: "https://fonts.gstatic.com/s/manrope/v15/xn7_YHE41ni1AdIRggexSd-fed4vYI.woff2",
            },
          ],
          preload: true,
          display: "swap",
          selector: "body",
          fallback: "sans-serif",
        },
      ]}
    />
    <script is:inline>
      // Always use light mode - remove dark class if present
      document.documentElement.classList.remove('dark');
    </script>
    <script is:inline define:vars={{ searchData }}>
      window.__SEARCH_DATA__ = searchData;
    </script>
  </head>
  <body class="bg-background text-foreground">
    <header class="border-b border-border bg-background z-50">
      <div class="max-w-5xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-2 md:gap-4">
          <a href="/" class="text-lg md:text-xl font-bold text-foreground hover:text-primary transition-colors whitespace-nowrap flex-shrink-0">
            üåê <span class="hidden sm:inline">{metadata.title}</span><span class="sm:hidden">logos.travel</span>
          </a>
          <div class="flex-1 flex justify-center max-w-xs md:max-w-md mx-2 md:mx-4 min-w-0">
            <SearchBar client:load />
          </div>
          {/* Desktop Navigation */}
          <nav class="hidden md:block flex-shrink-0">
            <ul class="flex items-center gap-3 md:gap-4 justify-center">
              <li>
                <a href="/" class="text-muted-foreground hover:text-foreground transition-colors">Home</a>
              </li>
              <li>
                <a href="/logos/" class="text-muted-foreground hover:text-foreground transition-colors">Logos</a>
              </li>
              <li>
                <TagsDropdown client:load tags={sortedTagsWithCounts} totalLogos={logos.length} />
              </li>
            </ul>
          </nav>
          {/* Mobile Menu */}
          <div class="md:hidden flex-shrink-0">
            <MobileMenu client:load tags={sortedTagsWithCounts} totalLogos={logos.length} />
          </div>
        </div>
      </div>
    </header>
    <main class="max-w-5xl mx-auto px-4 py-8 min-h-screen">
      <slot />
    </main>

    <footer class="mt-16 py-8 border-t border-border bg-black text-white">
      <div class="max-w-5xl mx-auto px-4 py-4">
        <nav class="mb-4">
          <ul class="flex items-center justify-center gap-4 flex-wrap">
            <li>
              <a href="/about/" class="text-sm hover:underline">About</a>
            </li>
            <li>
              <a href="/terms-of-use/" class="text-sm hover:underline">Terms of Use</a>
            </li>
          </ul>
        </nav>
        <p class="text-sm text-white/50 text-center">
          logos.travel is the simple way to explore, reference, and download logos from global travel brands. Designed for speed and clarity, it's your go-to resource for finding professional travel brand assets all in one place. All logos displayed on this website are not our intellectual property. The logos are the property of their respective owners and are protected by copyright, trademark, and other intellectual property laws.
        </p>
      </div>
    </footer>

    <!-- 100% privacy-first analytics -->
    <script data-collect-dnt="true" async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
    <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif?collect-dnt=true" alt="" referrerpolicy="no-referrer-when-downgrade"/></noscript>
  </body>
</html>
